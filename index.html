<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plano de Ação do CIG — SEGOV/SEGEST</title>
<meta name="description" content="Ferramenta guiada para elaboração do Plano de Ação do CIG das Administrações Regionais do DF">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #f1f5f9;
    --bg-card: #ffffff;
    --bg-input: #f8fafc;
    --border: #e2e8f0;
    --border-strong: #cbd5e1;
    --text-primary: #1e293b;
    --text-secondary: #475569;
    --text-muted: #64748b;
    --text-dim: #94a3b8;
    --accent-blue: #3b82f6;
    --accent-blue-dark: #2563eb;
    --accent-blue-light: #eff6ff;
    --accent-green: #10b981;
    --accent-green-dark: #059669;
    --accent-green-light: #ecfdf5;
    --accent-yellow: #d97706;
    --accent-yellow-light: #fffbeb;
    --accent-red: #ef4444;
    --accent-red-light: #fef2f2;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.04);
    --font: 'Source Sans 3', 'Segoe UI', system-ui, sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: var(--bg-deep);
    color: var(--text-primary);
    min-height: 100vh;
    padding: 24px 16px;
    -webkit-font-smoothing: antialiased;
  }

  ::selection { background: var(--accent-blue); color: #fff; }

  .container { max-width: 780px; margin: 0 auto; }

  /* Header */
  .header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
    background: var(--bg-card); border-radius: var(--radius);
    padding: 16px 20px; box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }
  .header-brand span {
    font-size: 10px; font-weight: 700; letter-spacing: 0.2em;
    color: var(--accent-blue-dark); text-transform: uppercase;
  }
  .header-brand h1 {
    font-size: 22px; font-weight: 900; color: var(--text-primary);
    letter-spacing: -0.02em; margin-top: 4px;
  }
  .header-actions { display: flex; gap: 8px; }

  /* Buttons */
  .btn-small {
    padding: 6px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border);
    background: var(--bg-card); color: var(--text-secondary); font-size: 12px;
    font-weight: 600; cursor: pointer; font-family: var(--font); transition: all 0.2s;
  }
  .btn-small:hover { background: var(--bg-deep); color: var(--text-primary); border-color: var(--border-strong); }

  .btn-nav {
    padding: 12px 28px; border-radius: 10px; font-size: 14px; font-weight: 700;
    cursor: pointer; font-family: var(--font); transition: all 0.2s; border: none;
  }
  .btn-nav-next { background: var(--accent-blue-dark); color: #fff; box-shadow: 0 2px 8px rgba(37,99,235,0.25); }
  .btn-nav-next:hover { background: var(--accent-blue); }
  .btn-nav-prev { background: var(--bg-card); color: var(--text-secondary); border: 1.5px solid var(--border-strong); }
  .btn-nav-prev:hover { background: var(--bg-deep); color: var(--text-primary); }
  .btn-nav-print { background: var(--accent-green-dark); color: #fff; box-shadow: 0 2px 8px rgba(5,150,105,0.25); }
  .btn-nav-print:hover { background: var(--accent-green); }
  .btn-nav-skip {
    padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: var(--font); transition: all 0.2s;
    background: transparent; color: var(--text-muted); border: 1.5px dashed var(--border-strong);
  }
  .btn-nav-skip:hover { color: var(--text-secondary); background: var(--bg-input); border-color: var(--accent-blue); }

  .btn-primary {
    padding: 14px 36px; border-radius: var(--radius); border: none;
    background: linear-gradient(135deg, var(--accent-blue-dark), var(--accent-blue));
    color: #fff; font-size: 16px; font-weight: 700; cursor: pointer;
    box-shadow: 0 4px 20px rgba(37,99,235,0.25); font-family: var(--font); transition: transform 0.2s;
  }
  .btn-primary:hover { transform: translateY(-1px); }

  .btn-ghost {
    padding: 14px 24px; border-radius: var(--radius); border: 1.5px solid var(--border-strong);
    background: var(--bg-card); color: var(--text-secondary); font-size: 14px;
    font-weight: 600; cursor: pointer; font-family: var(--font);
  }
  .btn-ghost:hover { background: var(--bg-deep); }

  /* Submit button */
  .btn-submit {
    padding: 16px 40px; border-radius: var(--radius); border: none;
    background: linear-gradient(135deg, #059669, #10b981);
    color: #fff; font-size: 17px; font-weight: 800; cursor: pointer;
    box-shadow: 0 4px 20px rgba(5,150,105,0.3); font-family: var(--font);
    transition: all 0.2s; width: 100%; letter-spacing: 0.01em;
  }
  .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(5,150,105,0.35); }
  .btn-submit:disabled {
    background: var(--border-strong); color: var(--text-dim);
    cursor: not-allowed; box-shadow: none; transform: none;
  }

  /* Loading spinner */
  .spinner {
    display: inline-block; width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.7s linear infinite;
    vertical-align: middle; margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Success screen */
  .success-screen { text-align: center; padding: 40px 0; }
  .success-icon { font-size: 64px; margin-bottom: 16px; animation: popIn 0.5s ease; }
  @keyframes popIn {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
  }
  .success-screen h2 { font-size: 26px; font-weight: 900; margin-bottom: 8px; color: var(--accent-green-dark); }
  .success-screen p { font-size: 15px; color: var(--text-secondary); max-width: 480px; margin: 0 auto 8px; line-height: 1.7; }
  .success-screen .sub { font-size: 13px; color: var(--text-muted); margin-bottom: 28px; }
  .success-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .success-badge {
    display: inline-block; margin-top: 16px; padding: 8px 20px;
    background: var(--accent-green-light); border: 1px solid #a7f3d0;
    border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--accent-green-dark);
  }

  /* Submission status on review */
  .submit-section {
    margin-top: 24px; padding: 20px; background: var(--accent-green-light);
    border: 1.5px solid #a7f3d0; border-radius: var(--radius); text-align: center;
  }
  .submit-section p { font-size: 13px; color: var(--text-secondary); margin-bottom: 14px; line-height: 1.6; }
  .already-sent {
    margin-top: 24px; padding: 16px; background: var(--accent-blue-light);
    border: 1px solid #bfdbfe; border-radius: var(--radius); text-align: center;
  }
  .already-sent p { font-size: 13px; color: var(--accent-blue-dark); margin-bottom: 10px; }

  /* Motivation messages */
  .motivation {
    text-align: center; padding: 8px 16px; margin-bottom: 16px;
    font-size: 13px; font-weight: 600; color: var(--accent-blue-dark);
    background: var(--accent-blue-light); border-radius: 20px;
    border: 1px solid #bfdbfe;
  }

  /* Progress */
  .progress-bar {
    margin-bottom: 20px; background: var(--bg-card); border-radius: var(--radius);
    padding: 14px 18px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);
  }
  .progress-info { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; }
  .progress-track { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-green)); border-radius: 3px; transition: width 0.4s ease; }
  .progress-dots { display: flex; gap: 3px; margin-top: 8px; justify-content: center; flex-wrap: wrap; }
  .progress-dot {
    height: 8px; border-radius: 4px; border: none; cursor: pointer;
    transition: all 0.3s ease; padding: 0;
  }
  .progress-dot-active { width: 24px; background: var(--accent-blue); }
  .progress-dot-done { width: 8px; background: var(--accent-green); }
  .progress-dot-todo { width: 8px; background: var(--border-strong); }
  .progress-dot:hover { opacity: 0.7; }
  .phase-label {
    text-align: center; margin-top: 6px; font-size: 11px; font-weight: 700;
    color: var(--accent-blue-dark); letter-spacing: 0.06em; text-transform: uppercase;
  }

  /* Navigation */
  .nav-row { display: flex; justify-content: space-between; align-items: center; margin-top: 24px; gap: 12px; }
  .nav-right { display: flex; gap: 8px; align-items: center; }

  /* Content area */
  .step-card {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 28px 24px; box-shadow: var(--shadow-md); border: 1px solid var(--border);
  }
  .step-content { transition: opacity 0.2s ease, transform 0.2s ease; }
  .step-content.fading { opacity: 0; transform: translateY(12px); }

  /* Question styling */
  .step-icon { font-size: 36px; display: block; margin-bottom: 8px; }
  .step-question { font-size: 24px; font-weight: 800; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em; }
  .step-hint { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }

  /* Context note (connects steps) */
  .step-contexto {
    font-size: 13px; color: var(--accent-blue-dark); background: var(--accent-blue-light);
    border: 1px solid #bfdbfe; border-radius: 8px; padding: 8px 14px;
    margin-bottom: 12px; line-height: 1.5;
  }

  /* Help tooltip */
  .ajuda-btn {
    background: none; border: 1px solid var(--border); cursor: pointer; font-size: 12px;
    vertical-align: middle; padding: 2px 8px; border-radius: 12px;
    color: var(--text-muted); font-family: var(--font); font-weight: 600;
    transition: all 0.2s; margin-left: 8px;
  }
  .ajuda-btn:hover { background: var(--accent-blue-light); color: var(--accent-blue-dark); border-color: #bfdbfe; }
  .ajuda-content {
    font-size: 13px; color: var(--text-secondary); background: #f0f9ff;
    border: 1px solid #bae6fd; border-radius: 8px; padding: 10px 14px;
    margin-top: 8px; margin-bottom: 12px; line-height: 1.6;
  }

  /* Optional/required labels */
  .optional-tag {
    font-size: 12px; font-weight: 400; color: var(--text-dim);
    font-style: italic; margin-left: 4px;
  }
  .required-legend {
    font-size: 11px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.5;
  }

  /* Examples */
  .examples-label {
    font-size: 11px; font-weight: 700; color: var(--accent-yellow);
    letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 8px;
  }
  .example-card {
    background: var(--accent-yellow-light); border: 1px solid #fde68a;
    border-radius: 10px; padding: 10px 14px; cursor: pointer;
    transition: all 0.2s; margin-bottom: 8px;
  }
  .example-card:hover { border-color: var(--accent-yellow); background: #fef3c7; }
  .example-tag { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 3px; }
  .example-text { font-size: 13px; color: var(--text-secondary); line-height: 1.55; }
  .examples-hint { font-size: 11px; color: var(--text-dim); margin-top: 6px; font-style: italic; margin-bottom: 16px; }

  /* Inputs */
  textarea, input[type="text"] {
    width: 100%; background: var(--bg-input); border: 2px solid var(--border);
    border-radius: var(--radius); padding: 14px 18px; font-size: 15px;
    color: var(--text-primary); line-height: 1.7; font-family: var(--font);
    resize: vertical; transition: border-color 0.2s; outline: none;
  }
  textarea:focus, input[type="text"]:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
  input[type="text"] { font-size: 16px; font-weight: 600; }

  select {
    width: 100%; background: var(--bg-input); border: 2px solid var(--border);
    border-radius: var(--radius); padding: 14px 18px; font-size: 16px;
    font-weight: 600; color: var(--text-primary); font-family: var(--font);
    cursor: pointer; transition: border-color 0.2s; outline: none;
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2364748b' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 16px center;
  }
  select:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

  textarea.small-textarea {
    font-size: 13.5px; padding: 10px 14px; border-radius: var(--radius-sm);
    border-width: 1.5px;
  }

  /* Partes interessadas */
  .partes-block {
    background: var(--bg-input); border-radius: var(--radius); padding: 16px;
    border: 1px solid var(--border); margin-bottom: 12px;
  }
  .partes-label { font-size: 12px; font-weight: 700; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
  .partes-examples { font-size: 11px; color: var(--accent-yellow); margin-bottom: 8px; }

  /* Entregas */
  .entrega-card {
    background: var(--bg-input); border: 1.5px solid var(--border); border-radius: var(--radius);
    padding: 16px; margin-bottom: 12px;
  }
  .entrega-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .entrega-badge {
    font-size: 12px; font-weight: 700; color: var(--accent-green-dark);
    background: var(--accent-green-light); padding: 3px 12px; border-radius: 20px;
    border: 1px solid #a7f3d0;
  }
  .entrega-remove {
    background: var(--accent-red-light); border: 1px solid #fecaca; border-radius: 6px;
    color: var(--accent-red); font-size: 11px; font-weight: 600; cursor: pointer;
    font-family: var(--font); padding: 4px 10px; transition: all 0.2s;
  }
  .entrega-remove:hover { background: #fee2e2; }
  .entrega-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .entrega-field-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }

  .btn-add-entrega {
    width: 100%; padding: 10px; border-radius: 10px; border: 1.5px dashed var(--border-strong);
    background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: var(--font); transition: all 0.2s;
  }
  .btn-add-entrega:hover { background: var(--bg-input); color: var(--text-secondary); border-color: var(--accent-blue); }

  /* Example block in entregas */
  .entregas-example {
    background: var(--accent-yellow-light); border: 1px solid #fde68a;
    border-radius: 10px; padding: 14px; margin-bottom: 16px;
  }

  /* Welcome */
  .welcome { text-align: center; padding: 40px 0; }
  .welcome-icon { font-size: 56px; margin-bottom: 16px; }
  .welcome h2 { font-size: 28px; font-weight: 900; margin-bottom: 12px; letter-spacing: -0.02em; }
  .welcome p { font-size: 16px; color: var(--text-secondary); max-width: 520px; margin: 0 auto 8px; line-height: 1.7; }
  .welcome .sub { font-size: 14px; color: var(--text-muted); max-width: 480px; margin: 0 auto 32px; line-height: 1.6; }
  .welcome-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
  .welcome-features {
    display: flex; gap: 24px; justify-content: center; margin-top: 40px; flex-wrap: wrap;
  }
  .welcome-feat {
    display: flex; align-items: center; gap: 8px; font-size: 13px;
    color: var(--text-muted); background: var(--bg-input);
    padding: 8px 14px; border-radius: 20px; border: 1px solid var(--border);
  }
  .welcome-feat span { font-size: 18px; }
  .welcome-info-toggle {
    background: none; border: 1px solid var(--border); border-radius: 20px;
    padding: 8px 20px; font-size: 13px; font-weight: 600; color: var(--accent-blue-dark);
    cursor: pointer; font-family: var(--font); transition: all 0.2s; margin-top: 24px;
    display: inline-block;
  }
  .welcome-info-toggle:hover { background: var(--accent-blue-light); border-color: #bfdbfe; }
  .welcome-info-content {
    margin-top: 16px; padding: 20px 24px; background: var(--bg-input);
    border: 1px solid var(--border); border-radius: var(--radius);
    text-align: left; max-width: 540px; margin-left: auto; margin-right: auto;
  }
  .welcome-info-content p {
    font-size: 14px !important; color: var(--text-secondary) !important;
    line-height: 1.7 !important; margin-bottom: 10px !important; max-width: none !important;
    text-align: left !important;
  }
  .welcome-info-content p:last-child { margin-bottom: 0 !important; }

  /* Autosave indicator */
  .autosave-indicator {
    position: fixed; bottom: 16px; right: 16px; padding: 6px 14px;
    background: var(--accent-green-light); color: var(--accent-green-dark);
    border: 1px solid #a7f3d0; border-radius: 20px;
    font-size: 11px; font-weight: 600; font-family: var(--font);
    opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100;
  }
  .autosave-indicator.show { opacity: 1; }

  /* Review */
  .review-header { text-align: center; margin-bottom: 28px; }
  .review-header .icon { font-size: 48px; margin-bottom: 8px; }
  .review-header h2 { font-size: 26px; font-weight: 900; margin-bottom: 6px; }
  .review-header p { font-size: 14px; color: var(--text-secondary); }
  .review-ra {
    display: inline-block; margin-top: 12px; padding: 6px 18px;
    background: var(--accent-blue-light); border: 1px solid #bfdbfe;
    border-radius: 20px; font-size: 14px; font-weight: 700; color: var(--accent-blue-dark);
  }

  .review-item {
    display: flex; align-items: flex-start; gap: 12px;
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 16px; cursor: pointer; width: 100%; text-align: left;
    transition: all 0.2s; font-family: var(--font); margin-bottom: 8px;
    box-shadow: var(--shadow-sm);
  }
  .review-item:hover { border-color: var(--accent-blue); box-shadow: 0 2px 8px rgba(59,130,246,0.1); }
  .review-item.pending { background: var(--accent-red-light); border-color: #fecaca; }
  .review-item-icon { font-size: 20px; flex-shrink: 0; }
  .review-item-body { flex: 1; min-width: 0; }
  .review-item-label { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
  .review-item-label.filled { color: var(--text-primary); }
  .review-item-label.empty { color: var(--accent-red); }
  .review-item-preview {
    font-size: 12px; color: var(--text-muted); overflow: hidden;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    white-space: pre-wrap; line-height: 1.5;
  }
  .review-edit { color: var(--text-dim); font-size: 16px; flex-shrink: 0; }
  .review-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }

  /* Error message */
  .error-msg {
    margin-top: 12px; padding: 12px 16px; background: var(--accent-red-light);
    border: 1px solid #fecaca; border-radius: var(--radius-sm);
    font-size: 13px; color: #991b1b; text-align: center;
  }

  /* Footer */
  .footer {
    text-align: center; font-size: 10px; color: var(--text-dim);
    margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--border); line-height: 1.6;
  }

  /* Print styles */
  @media print {
    body { background: #fff !important; color: #000 !important; padding: 16px; }
    .no-print { display: none !important; }
    .container { max-width: 100%; }
    .step-card { box-shadow: none !important; border: 1px solid #ddd !important; }
    textarea, input[type="text"], select { border: 1px solid #ccc !important; background: #fff !important; color: #000 !important; min-height: 30px !important; font-size: 12px !important; box-shadow: none !important; }
    .step-question { color: #000 !important; font-size: 16px !important; }
    .step-hint { color: #333 !important; font-size: 11px !important; }
    .step-icon { font-size: 20px !important; }
    .review-item { background: #f9f9f9 !important; border-color: #ddd !important; box-shadow: none !important; }
    .review-item-label { color: #000 !important; }
    .review-item-preview { color: #333 !important; }
    .footer { color: #999 !important; border-top-color: #ddd !important; }
    .header { box-shadow: none !important; }
    .header-brand h1 { color: #000 !important; }
    .header-brand span { color: #666 !important; }
    .review-ra { background: #e0e7ff !important; color: #1e40af !important; }
    .autosave-indicator { display: none !important; }
  }

  /* Responsive */
  @media (max-width: 600px) {
    .welcome h2 { font-size: 22px; }
    .step-question { font-size: 20px; }
    .entrega-grid { grid-template-columns: 1fr; }
    .welcome-features { flex-direction: column; align-items: center; }
    .nav-row { flex-direction: column; }
    .nav-right { width: 100%; justify-content: center; }
    .btn-nav { width: 100%; text-align: center; }
    .review-actions { flex-direction: column; }
    .review-actions button { width: 100%; text-align: center; }
    .success-actions { flex-direction: column; }
    .success-actions button { width: 100%; }
    .step-card { padding: 20px 16px; }
  }
</style>
</head>
<body>

<div class="container" id="app"></div>
<div class="autosave-indicator" id="autosave-indicator">Salvo automaticamente</div>

<script>
/* ===================================================
   CONFIGURAÇÃO - COLE AQUI A URL DO SEU GOOGLE APPS SCRIPT
   =================================================== */
var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzvLX37nFf9wZrSga5WzuXcG56ZLSgc1p7akVW4_52kZAUD-TjF69CsCEPbd_t-X05QEw/exec';

/* ===================================================
   REGIÕES ADMINISTRATIVAS DO DF
   =================================================== */
var REGIOES_DF = [
  "RA-I Plano Piloto",
  "RA-II Gama",
  "RA-III Taguatinga",
  "RA-IV Brazlândia",
  "RA-V Sobradinho",
  "RA-VI Planaltina",
  "RA-VII Paranoá",
  "RA-VIII Núcleo Bandeirante",
  "RA-IX Ceilândia",
  "RA-X Guará",
  "RA-XI Cruzeiro",
  "RA-XII Samambaia",
  "RA-XIII Santa Maria",
  "RA-XIV São Sebastião",
  "RA-XV Recanto das Emas",
  "RA-XVI Lago Sul",
  "RA-XVII Riacho Fundo",
  "RA-XVIII Lago Norte",
  "RA-XIX Candangolândia",
  "RA-XX Águas Claras",
  "RA-XXI Riacho Fundo II",
  "RA-XXII Sudoeste/Octogonal",
  "RA-XXIII Varjão",
  "RA-XXIV Park Way",
  "RA-XXV SCIA/Estrutural",
  "RA-XXVI Sobradinho II",
  "RA-XXVII Jardim Botânico",
  "RA-XXVIII Itapoã",
  "RA-XXIX SIA",
  "RA-XXX Vicente Pires",
  "RA-XXXI Fercal",
  "RA-XXXII Sol Nascente e Pôr do Sol",
  "RA-XXXIII Arniqueira",
  "RA-XXXIV Arapoanga",
  "RA-XXXV Água Quente"
];

/* ===================================================
   PRÁTICAS DE GOVERNANÇA (Resolução CGOV Nº 04/2024)
   =================================================== */
var PRATICAS_GOVERNANCA = [
  "Comitê Interno de Governança (CIG)",
  "Planejamento Estratégico",
  "Gestão de Riscos",
  "Programa de Integridade Pública",
  "Programa de Integridade Privada",
  "Conformidade",
  "Controle Interno",
  "Correição",
  "Ouvidoria",
  "Transparência",
  "Governança de Pessoas",
  "Governança de Dados",
  "Governança nas Contratações",
  "Gerenciamento de Processos",
  "Inovação",
  "Dimensão Ambiental",
  "Dimensão Social"
];

/* ===================================================
   FASES DO CANVAS (agrupamento visual)
   =================================================== */
var PHASES = [
  { name: "Identidade do Projeto", steps: ["ra", "pratica", "projeto", "objetivo"] },
  { name: "Detalhamento", steps: ["descricao", "produto", "caracteristicas"] },
  { name: "Análise", steps: ["justificativa", "indicador"] },
  { name: "Pessoas e Planejamento", steps: ["partes", "entregas"] },
  { name: "Riscos e Premissas", steps: ["premissas", "barreiras", "riscos"] }
];

function getPhaseForStep(stepId) {
  for (var i = 0; i < PHASES.length; i++) {
    if (PHASES[i].steps.indexOf(stepId) >= 0) return PHASES[i].name;
  }
  return '';
}

/* ===================================================
   CAMPOS OBRIGATÓRIOS
   =================================================== */
var REQUIRED_FIELDS = ['ra', 'pratica', 'projeto', 'objetivo', 'descricao', 'produto', 'caracteristicas', 'justificativa', 'indicador', 'partes', 'entregas', 'premissas', 'barreiras', 'riscos'];

function isRequired(fieldOrId) {
  return REQUIRED_FIELDS.indexOf(fieldOrId) >= 0;
}

/* ===================================================
   STEPS DATA
   =================================================== */
var STEPS = [
  { id: "welcome", type: "welcome" },
  {
    id: "ra", field: "ra", label: "Região Administrativa",
    question: "Qual é a sua Região Administrativa?",
    dica: "Selecione sua RA na lista abaixo.",
    placeholder: "Selecione sua Região Administrativa...",
    icon: "\uD83D\uDCCD", color: "#3b82f6", inputType: "select",
    opcoes: REGIOES_DF, exemplos: []
  },
  {
    id: "pratica", field: "pratica", label: "Prática de Governança",
    question: "A qual prática de governança este projeto se refere?",
    contexto: "Cada projeto do Plano de Ação do CIG deve estar vinculado a uma das práticas do Modelo de Governança Pública do DF.",
    dica: "Selecione a prática de governança principal que o projeto vai implementar ou fortalecer, conforme a Resolução CGOV Nº 04/2024.",
    placeholder: "Selecione a prática de governança...",
    icon: "\uD83C\uDFDB\uFE0F", color: "#7c3aed", inputType: "select",
    opcoes: PRATICAS_GOVERNANCA, exemplos: []
  },
  {
    id: "projeto", field: "projeto", label: "Nome do Projeto",
    question: "Qual é o nome do seu projeto?",
    contexto: "Agora que identificou sua RA, vamos nomear o projeto.",
    dica: "Escolha um nome claro e direto. Inclua a sigla da RA para facilitar a identificação.",
    placeholder: "Digite o nome do projeto...",
    icon: "\uD83C\uDFAF", color: "#3b82f6",
    exemplos: [
      { titulo: "Governança", texto: "Implantação do Comitê Interno de Governança (CIG) da RA-IX" },
      { titulo: "Atendimento", texto: "Modernização do Atendimento ao Cidadão na RA-III Taguatinga" },
      { titulo: "Gestão de Riscos", texto: "Programa de Gestão de Riscos Operacionais da RA-I Plano Piloto" },
      { titulo: "Transparência", texto: "Portal de Transparência e Prestação de Contas da RA-V Sobradinho" }
    ]
  },
  {
    id: "objetivo", field: "objetivo", label: "Objetivo do Projeto",
    question: "O que este projeto pretende alcançar?",
    contexto: "Com o nome definido, descreva a meta principal do projeto.",
    dica: "Descreva o resultado final desejado. Use verbos como: estruturar, implantar, reduzir, melhorar...",
    placeholder: "Descreva o objetivo principal...",
    icon: "\uD83C\uDFC6", color: "#dc2626",
    exemplos: [
      { titulo: "Governança", texto: "Estruturar o CIG como instância deliberativa para qualificar decisões e dar segurança jurídica à gestão da RA." },
      { titulo: "Atendimento", texto: "Reduzir em 50% o tempo de espera do cidadão e implantar sistema de agendamento online." },
      { titulo: "Contratos", texto: "Garantir 100% de conformidade na fiscalização de contratos vigentes da RA." }
    ]
  },
  {
    id: "descricao", field: "descricao", label: "Descrição do Projeto",
    question: "Descreva brevemente o projeto.",
    contexto: "Você definiu o objetivo. Agora descreva como pretende chegar lá.",
    dica: "Diferente do objetivo (o que quer alcançar), aqui descreva o que será feito na prática, a abrangência e a quais diretrizes está vinculado.",
    placeholder: "Descreva o escopo e contexto...",
    icon: "\uD83D\uDCCB", color: "#2563eb",
    exemplos: [
      { titulo: "Governança", texto: "Formalização do CIG por portaria, elaboração de regimento interno, capacitação dos membros e início das reuniões ordinárias mensais, alinhado às diretrizes da SEGOV/CGDF." },
      { titulo: "Capacitação", texto: "Programa de capacitação continuada para 45 servidores da RA em gestão pública, integridade e atendimento, com 6 módulos ao longo de 12 meses." }
    ]
  },
  {
    id: "produto", field: "produto", label: "Produto Principal",
    question: "Qual é o resultado concreto que será entregue?",
    contexto: "Pensando na descrição do projeto, qual será a entrega principal e tangível?",
    dica: "Diferente do objetivo (abstrato), o produto é algo concreto \u2014 que se possa apontar e dizer: \"isto foi entregue\".",
    placeholder: "O principal produto do projeto...",
    icon: "\uD83D\uDCE6", color: "#ea580c",
    exemplos: [
      { titulo: "Governança", texto: "CIG formalmente instituído, com regimento aprovado e reuniões ordinárias em funcionamento." },
      { titulo: "Atendimento", texto: "Central de atendimento reorganizada com sistema de senhas, agendamento e pesquisa de satisfação." },
      { titulo: "Riscos", texto: "Matriz de riscos da RA elaborada com planos de tratamento para os 10 riscos prioritários." }
    ]
  },
  {
    id: "caracteristicas", field: "caracteristicas", label: "Características",
    question: "Quais são as características essenciais desse produto?",
    contexto: "Sobre o produto que você descreveu acima, que qualidades ele precisa ter?",
    dica: "Liste os atributos que tornam o produto completo. Pense: \"para funcionar bem, ele precisa ser/ter...\"",
    ajuda: "Características são os atributos de qualidade do que será entregue. Exemplo: se o produto é um comitê, as características podem ser 'reuniões mensais', 'atas no SEI', 'composição multissetorial'.",
    placeholder: "Características do produto principal...",
    icon: "\u2B50", color: "#7c3aed",
    exemplos: [
      { titulo: "CIG", texto: "Composição multissetorial \u2022 Reuniões mensais com ata no SEI \u2022 Pauta estruturada \u2022 Deliberações registradas \u2022 Alinhamento com a SEGOV/CGDF." },
      { titulo: "Atendimento", texto: "Acessível a PCD \u2022 Bilíngue (português/Libras) \u2022 Tempo máximo de espera: 15 min \u2022 Pesquisa de satisfação digital." }
    ]
  },
  {
    id: "justificativa", field: "justificativa", label: "Justificativa",
    question: "Por que este projeto é necessário?",
    contexto: "Agora explique por que vale a pena investir neste projeto.",
    dica: "Responda: qual problema resolve? Que risco evita? Por que agora? Traga dados se possível.",
    placeholder: "O que motiva este projeto...",
    icon: "\u2705", color: "#059669",
    exemplos: [
      { titulo: "Governança", texto: "A ausência de instância formal de governança expõe a gestão a riscos em auditorias do TCDF. As oficinas SEGOV/CGDF criaram a base técnica para implementação imediata." },
      { titulo: "Atendimento", texto: "Pesquisa da Ouvidoria indica que 67% das reclamações referem-se a tempo de espera. A RA atende 12 mil cidadãos/mês sem sistema de organização." }
    ]
  },
  {
    id: "indicador", field: "indicador", label: "Indicador de Resultado",
    question: "Como você vai medir o sucesso?",
    contexto: "Definida a justificativa, como saberemos se o projeto deu certo?",
    dica: "Pense em números concretos: percentuais, quantidades, prazos. Se o projeto der certo, que número muda?",
    ajuda: "Indicadores são números que mostram se o projeto está funcionando. Pense em algo que você possa contar ou medir. Exemplo: 'número de reuniões realizadas' ou 'tempo médio de atendimento'.",
    placeholder: "Indicadores de sucesso...",
    icon: "\uD83D\uDCCA", color: "#059669",
    exemplos: [
      { titulo: "Governança", texto: "% de reuniões realizadas vs. programadas (meta: 100%).\nN\u00BA de riscos identificados e tratados.\nÍndice de conformidade no checklist da CGDF." },
      { titulo: "Atendimento", texto: "Tempo médio de espera (meta: < 15 min).\nÍndice de satisfação do cidadão (meta: > 80%).\nN\u00BA de atendimentos/dia." }
    ]
  },
  {
    id: "partes", type: "partes", label: "Partes Interessadas",
    question: "Quem está envolvido no projeto?",
    contexto: "Agora vamos identificar as pessoas e grupos ligados ao projeto.",
    icon: "\uD83D\uDC65", color: "#334155",
    dica: "Identifique quem patrocina (apoia/decide), quem executa (faz o trabalho) e quem se beneficia (usa o resultado).",
    ajuda: "Partes interessadas são todas as pessoas ou grupos que influenciam ou são influenciados pelo projeto: quem decide, quem executa, quem usa o resultado final.",
    exemplos: {
      patrocinio: ["Administrador(a) Regional (patrocinador)", "Chefe de Gabinete (gestor do projeto)"],
      equipe: ["Membros do CIG capacitados nas oficinas", "Representantes das coordenações", "Assessoria jurídica da RA"],
      publico: ["Diretos: servidores e gestores da RA", "Indiretos: população da região administrativa", "Órgãos de controle: TCDF, CGDF"]
    }
  },
  {
    id: "entregas", type: "entregas", label: "Entregas Intermediárias",
    question: "Quebre o projeto em etapas \u2014 o que será entregue em cada uma?",
    contexto: "Com tudo definido, divida o projeto em etapas menores e concretas.",
    icon: "\uD83D\uDCC5", color: "#059669",
    dica: "Cada entrega deve ter: o que será entregue, as atividades necessárias, prazo e custo estimado. Comece com 1 ou 2 entregas \u2014 você pode adicionar mais depois.",
    ajuda: "Entregas intermediárias são os marcos do projeto \u2014 resultados parciais que mostram que o trabalho está avançando. Pense nos passos até chegar ao produto final.",
    exemplos: [
      { entrega: "Ato normativo do CIG publicado.", atividades: "Minutar portaria \u2192 Assessoria jurídica \u2192 Assinatura \u2192 Publicação no DODF.", prazo: "30 dias", investimento: "Sem custo direto." },
      { entrega: "1\u00AA reunião ordinária realizada.", atividades: "Regimento aprovado \u2192 Pauta definida \u2192 Convocação \u2192 Ata registrada no SEI.", prazo: "60 dias", investimento: "Sem custo direto." }
    ]
  },
  {
    id: "premissas", field: "premissas", label: "Premissas",
    question: "O que precisa dar certo para o projeto funcionar?",
    contexto: "Quase lá! Pense nas condições necessárias para o sucesso do projeto.",
    dica: "São condições que você assume como verdadeiras. Se alguma falhar, o projeto fica comprometido.",
    ajuda: "Premissas são coisas que você assume como certas para o projeto funcionar. Exemplo: 'os servidores terão tempo dedicado', 'o SEI estará disponível'. Se alguma premissa falhar, o projeto pode ser prejudicado.",
    placeholder: "Fatores críticos de sucesso...",
    icon: "\uD83C\uDFC5", color: "#b45309",
    exemplos: [
      { titulo: "Típicas", texto: "Apoio do(a) Administrador(a) Regional.\nServidores capacitados com disponibilidade de tempo.\nAcesso ao SEI funcionando.\nSuporte técnico da SEGOV conforme comprometido." }
    ]
  },
  {
    id: "barreiras", field: "barreiras", label: "Barreiras",
    question: "Quais dificuldades já existem hoje?",
    contexto: "Pensando na realidade da sua RA, que obstáculos já existem?",
    dica: "Diferente de riscos (que podem acontecer), barreiras são obstáculos conhecidos e atuais \u2014 coisas que já atrapalham.",
    placeholder: "Dificuldades existentes...",
    icon: "\uD83D\uDEA7", color: "#dc2626",
    exemplos: [
      { titulo: "Comuns nas RAs", texto: "Acúmulo de funções dos servidores.\nResistência cultural a mudanças.\nRotatividade em cargos comissionados.\nInfraestrutura limitada (salas, equipamentos)." }
    ]
  },
  {
    id: "riscos", field: "riscos", label: "Riscos",
    question: "O que pode dar errado no futuro?",
    contexto: "Último passo! Pense no que pode acontecer de inesperado.",
    dica: "Eventos incertos mas possíveis. Pense: \"e se acontecer X, como impacta o projeto?\"",
    placeholder: "Eventos que podem impactar...",
    icon: "\u26A0\uFE0F", color: "#d97706",
    exemplos: [
      { titulo: "Frequentes", texto: "Troca de Administrador(a) com descontinuidade.\nPerda de servidores capacitados por remoção.\nSobrecarga de demandas urgentes.\nCorte orçamentário inesperado." }
    ]
  },
  { id: "review", type: "review" }
];

/* ===================================================
   MOTIVATION MESSAGES
   =================================================== */
var MOTIVATIONS = [
  { min: 0, max: 10, msg: "Vamos lá! O primeiro passo é o mais importante." },
  { min: 11, max: 25, msg: "Ótimo começo! Continue preenchendo, está ficando bom." },
  { min: 26, max: 50, msg: "Quase na metade! Seu projeto já está tomando forma." },
  { min: 51, max: 75, msg: "Mais da metade! O plano está ficando completo." },
  { min: 76, max: 95, msg: "Falta pouco! Seu projeto está quase pronto para enviar." },
  { min: 96, max: 100, msg: "Excelente! Plano 100% preenchido. Hora de enviar!" }
];

function getMotivation(pct) {
  for (var i = 0; i < MOTIVATIONS.length; i++) {
    if (pct >= MOTIVATIONS[i].min && pct <= MOTIVATIONS[i].max) return MOTIVATIONS[i].msg;
  }
  return '';
}

/* ===================================================
   STATE
   =================================================== */
var STORAGE_KEY = 'canvas-projeto-data';
var STORAGE_STEP_KEY = 'canvas-projeto-step';
var STORAGE_SENT_KEY = 'canvas-projeto-sent';

var currentStep = 0;
var submitting = false;
var showSuccess = false;

var data = {
  ra: "", pratica: "", projeto: "", objetivo: "", descricao: "",
  produto: "", caracteristicas: "", justificativa: "",
  indicador: "", patrocinio: "", equipe: "", publico: "",
  premissas: "", barreiras: "", riscos: "",
  entregas: [
    { entrega: "", atividades: "", prazo: "", investimento: "Sem custo direto" }
  ]
};

/* ===================================================
   LOCALSTORAGE PERSISTENCE
   =================================================== */
function loadFromStorage() {
  try {
    var saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      var parsed = JSON.parse(saved);
      var exportDate = parsed.exportDate;
      delete parsed.exportDate;
      Object.keys(parsed).forEach(function(k) { data[k] = parsed[k]; });
    }
    var savedStep = localStorage.getItem(STORAGE_STEP_KEY);
    if (savedStep) {
      var step = parseInt(savedStep, 10);
      if (!isNaN(step) && step >= 0 && step < STEPS.length) {
        currentStep = step;
      }
    }
  } catch (e) { /* ignore corrupt data */ }
}

function getSentInfo() {
  try {
    var s = localStorage.getItem(STORAGE_SENT_KEY);
    return s ? JSON.parse(s) : null;
  } catch (e) { return null; }
}

function markAsSent() {
  try {
    localStorage.setItem(STORAGE_SENT_KEY, JSON.stringify({
      timestamp: new Date().toISOString(),
      ra: data.ra,
      projeto: data.projeto
    }));
  } catch (e) { /* ignore */ }
}

var autosaveTimeout = null;
function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    localStorage.setItem(STORAGE_STEP_KEY, String(currentStep));
    showAutosaveIndicator();
  } catch (e) { /* storage full or unavailable */ }
}

function showAutosaveIndicator() {
  var el = document.getElementById('autosave-indicator');
  if (!el) return;
  el.classList.add('show');
  clearTimeout(autosaveTimeout);
  autosaveTimeout = setTimeout(function() { el.classList.remove('show'); }, 1500);
}

function scheduleAutosave() {
  saveCurrentInputs();
  saveToStorage();
}

/* ===================================================
   HELPERS
   =================================================== */
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function getProgress() {
  var fields = [data.ra, data.pratica, data.projeto, data.objetivo, data.descricao, data.produto,
    data.caracteristicas, data.justificativa, data.indicador,
    data.patrocinio, data.equipe, data.publico,
    data.premissas, data.barreiras, data.riscos];
  var ef = [];
  data.entregas.forEach(function(e) { ef.push(e.entrega, e.atividades, e.prazo, e.investimento); });
  var all = fields.concat(ef);
  var filled = all.filter(function(f) { return f && f.trim(); }).length;
  return Math.round((filled / all.length) * 100);
}

function getRequiredEmpty() {
  var required = [
    { field: 'ra', label: 'Região Administrativa' },
    { field: 'pratica', label: 'Prática de Governança' },
    { field: 'projeto', label: 'Nome do Projeto' },
    { field: 'objetivo', label: 'Objetivo' }
  ];
  var empty = [];
  required.forEach(function(r) {
    if (!data[r.field] || !data[r.field].trim()) empty.push(r.label);
  });
  return empty;
}

function goTo(idx) {
  saveCurrentInputs();
  saveToStorage();
  var content = document.querySelector('.step-content');
  if (content) {
    content.classList.add('fading');
    setTimeout(function() { currentStep = idx; showSuccess = false; render(); }, 200);
  } else {
    currentStep = idx;
    showSuccess = false;
    render();
  }
}

function next() { if (currentStep < STEPS.length - 1) goTo(currentStep + 1); }
function prev() { if (currentStep > 0) goTo(currentStep - 1); }

function saveCurrentInputs() {
  var step = STEPS[currentStep];
  if (step.field) {
    var el = document.getElementById('field-' + step.field);
    if (el) data[step.field] = el.value;
  }
  if (step.type === 'partes') {
    ['patrocinio', 'equipe', 'publico'].forEach(function(k) {
      var el = document.getElementById('field-' + k);
      if (el) data[k] = el.value;
    });
  }
  if (step.type === 'entregas') {
    data.entregas.forEach(function(_, i) {
      ['entrega', 'atividades', 'prazo', 'investimento'].forEach(function(k) {
        var el = document.getElementById('ent-' + i + '-' + k);
        if (el) data.entregas[i][k] = el.value;
      });
    });
  }
}

function exportJSON() {
  saveCurrentInputs();
  saveToStorage();
  var blob = new Blob([JSON.stringify(Object.assign({}, data, { exportDate: new Date().toISOString() }), null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'plano-acao-' + (data.ra || 'cig').replace(/[^a-zA-Z0-9]/g, '-') + '-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var imp = JSON.parse(ev.target.result);
        delete imp.exportDate;
        Object.keys(imp).forEach(function(k) { data[k] = imp[k]; });
        saveToStorage();
        if (currentStep === 0) currentStep = 1;
        render();
      } catch (err) { alert('Arquivo inválido.'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

/* Melhoria #8: Exemplo clicável mesmo com campo preenchido */
function handleExampleClick(e) {
  var card = e.currentTarget;
  var field = card.dataset.field;
  var text = card.dataset.text;
  if (!data[field] || !data[field].trim()) {
    data[field] = text;
    var el = document.getElementById('field-' + field);
    if (el) el.value = text;
    scheduleAutosave();
  } else {
    if (confirm('O campo já está preenchido. Deseja substituir pelo exemplo?')) {
      data[field] = text;
      var el = document.getElementById('field-' + field);
      if (el) el.value = text;
      scheduleAutosave();
    }
  }
}

/* Melhoria #6: Pré-preencher investimento */
function addEntrega() {
  saveCurrentInputs();
  data.entregas.push({ entrega: '', atividades: '', prazo: '', investimento: 'Sem custo direto' });
  saveToStorage();
  render();
}

function removeEntrega(idx) {
  if (data.entregas.length <= 1) return;
  var entry = data.entregas[idx];
  var hasContent = entry.entrega.trim() || entry.atividades.trim() || entry.prazo.trim() || (entry.investimento.trim() && entry.investimento.trim() !== 'Sem custo direto');
  if (hasContent && !confirm('Tem certeza que deseja remover a Entrega ' + (idx + 1) + '? Os dados preenchidos serão perdidos.')) {
    return;
  }
  saveCurrentInputs();
  data.entregas.splice(idx, 1);
  saveToStorage();
  render();
}

function clearAllData() {
  if (!confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(STORAGE_STEP_KEY);
  localStorage.removeItem(STORAGE_SENT_KEY);
  data = {
    ra: "", pratica: "", projeto: "", objetivo: "", descricao: "",
    produto: "", caracteristicas: "", justificativa: "",
    indicador: "", patrocinio: "", equipe: "", publico: "",
    premissas: "", barreiras: "", riscos: "",
    entregas: [
      { entrega: "", atividades: "", prazo: "", investimento: "Sem custo direto" }
    ]
  };
  currentStep = 0;
  showSuccess = false;
  render();
}

/* Toggle da explicação do Plano de Ação */
function toggleCanvasInfo() {
  var el = document.getElementById('canvas-info-content');
  var btn = document.getElementById('canvas-info-btn');
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = 'block';
    if (btn) btn.textContent = 'Fechar explicação';
  } else {
    el.style.display = 'none';
    if (btn) btn.textContent = 'O que é o Plano de Ação do CIG?';
  }
}

function toggleAjuda(btn) {
  var content = btn.parentElement.nextElementSibling;
  if (!content || !content.classList.contains('ajuda-content')) return;
  if (content.style.display === 'none') {
    content.style.display = 'block';
    btn.textContent = 'Fechar';
  } else {
    content.style.display = 'none';
    btn.textContent = 'Saiba mais';
  }
}

/* ===================================================
   SUBMIT TO GOOGLE SHEETS
   =================================================== */
function submitToSEGOV() {
  if (submitting) return;

  saveCurrentInputs();
  saveToStorage();

  // Validate minimum fields
  var empty = getRequiredEmpty();
  if (empty.length > 0) {
    alert('Por favor, preencha os campos obrigatórios antes de enviar:\n\n- ' + empty.join('\n- '));
    return;
  }

  if (GOOGLE_SCRIPT_URL === 'COLE_SUA_URL_AQUI') {
    alert('O envio ainda não foi configurado.\n\nO administrador precisa configurar a URL do Google Apps Script.');
    return;
  }

  submitting = true;
  render();

  var payload = Object.assign({}, data, {
    submittedAt: new Date().toISOString(),
    userAgent: navigator.userAgent
  });

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(function() {
    submitting = false;
    showSuccess = true;
    markAsSent();
    render();
  })
  .catch(function(err) {
    submitting = false;
    render();
    var errorEl = document.getElementById('submit-error');
    if (errorEl) {
      errorEl.style.display = 'block';
      errorEl.textContent = 'Erro ao enviar. Verifique sua conexão e tente novamente.';
    }
  });
}

/* ===================================================
   INPUT EVENT LISTENERS (autosave on typing)
   =================================================== */
var inputDebounce = null;
function attachInputListeners() {
  document.querySelectorAll('#app textarea, #app input[type="text"], #app select').forEach(function(el) {
    el.addEventListener('input', function() {
      clearTimeout(inputDebounce);
      inputDebounce = setTimeout(scheduleAutosave, 800);
    });
    if (el.tagName === 'SELECT') {
      el.addEventListener('change', function() {
        scheduleAutosave();
      });
    }
  });
}

/* ===================================================
   RENDERERS
   =================================================== */

/* Welcome com explicação e import condicional */
function renderWelcome() {
  var hasSaved = localStorage.getItem(STORAGE_KEY);
  var resumeBtn = hasSaved
    ? '<button class="btn-ghost" onclick="goTo(1)">Continuar de onde parou</button>'
    : '';

  return '<div class="welcome">' +
    '<div class="welcome-icon">\uD83C\uDFDB\uFE0F</div>' +
    '<h2>Plano de Ação do CIG</h2>' +
    '<p>Elabore o <strong>Plano de Ação do Comitê Interno de Governança</strong> da sua Região Administrativa de forma guiada, passo a passo.</p>' +
    '<p class="sub">Iniciativa da <strong>Secretaria de Estado de Governo (SEGOV)</strong> e da <strong>Controladoria-Geral do DF (CGDF)</strong>, conforme o Modelo de Governança Pública do DF (Resolução CGOV Nº 04/2024).</p>' +
    '<div class="welcome-btns">' +
      '<button class="btn-primary" onclick="next()">Começar</button>' +
      resumeBtn +
    '</div>' +
    '<div style="margin-top:24px">' +
      '<button class="welcome-info-toggle" id="canvas-info-btn" onclick="toggleCanvasInfo()">O que é o Plano de Ação do CIG?</button>' +
      '<div id="canvas-info-content" class="welcome-info-content" style="display:none">' +
        '<p><strong>O Plano de Ação do CIG</strong> é o instrumento que organiza os projetos de governança de cada Administração Regional em uma estrutura clara e objetiva.</p>' +
        '<p>De acordo com o <strong>Modelo de Governança Pública do Governo do DF</strong> (Resolução CGOV Nº 04/2024), cada RA deve implementar práticas de governança monitoradas pela SEGOV e pela CGDF.</p>' +
        '<p>Este formulário guia você por cada campo, com exemplos práticos para inspirar. Suas respostas são salvas automaticamente no navegador. Ao final, o plano é enviado diretamente para a SEGOV.</p>' +
        '<p>Não se preocupe em acertar tudo de primeira! Você pode voltar e editar qualquer campo a qualquer momento.</p>' +
      '</div>' +
    '</div>' +
  '</div>';
}

/* Melhorias #1 (select), #2 (obrigatório/opcional), #5 (contexto), #7 (tooltip) */
function renderField(step) {
  /* Melhoria #5: Contexto conectando passos */
  var contextoHTML = step.contexto ? '<div class="step-contexto">' + esc(step.contexto) + '</div>' : '';

  var exHTML = '';
  if (step.exemplos && step.exemplos.length) {
    exHTML = '<div class="examples-label">\uD83D\uDCA1 Exemplos para inspirar</div>';
    step.exemplos.forEach(function(ex) {
      exHTML += '<div class="example-card" data-field="' + esc(step.field) + '" data-text="' + esc(ex.texto) + '" title="Clique para usar como base">' +
        '<div class="example-tag" style="color:' + step.color + '">' + esc(ex.titulo) + '</div>' +
        '<div class="example-text">' + esc(ex.texto) + '</div>' +
      '</div>';
    });
    exHTML += '<div class="examples-hint">Clique num exemplo para usá-lo como ponto de partida, ou escreva o seu abaixo</div>';
  }

  var reqLabel = ' <span style="color:var(--accent-red);font-size:18px" title="Campo obrigatório">*</span>';
  var optLabel = '';

  var ajudaBtnHTML = step.ajuda ? ' <button class="ajuda-btn" onclick="toggleAjuda(this)">Saiba mais</button>' : '';
  var ajudaBlockHTML = step.ajuda ? '<div class="ajuda-content" style="display:none">' + esc(step.ajuda) + '</div>' : '';

  /* Select para RA */
  var inputHTML = '';
  if (step.inputType === 'select') {
    inputHTML = '<label class="sr-only" for="field-' + step.field + '">' + esc(step.label) + '</label>' +
      '<select id="field-' + step.field + '">' +
      '<option value="">' + esc(step.placeholder || 'Selecione...') + '</option>';
    step.opcoes.forEach(function(op) {
      inputHTML += '<option value="' + esc(op) + '"' + (data[step.field] === op ? ' selected' : '') + '>' + esc(op) + '</option>';
    });
    inputHTML += '</select>';
  } else if (step.inputType === 'input') {
    inputHTML = '<label class="sr-only" for="field-' + step.field + '">' + esc(step.label) + '</label>' +
      '<input type="text" id="field-' + step.field + '" value="' + esc(data[step.field]) + '" placeholder="' + esc(step.placeholder) + '">';
  } else {
    inputHTML = '<label class="sr-only" for="field-' + step.field + '">' + esc(step.label) + '</label>' +
      '<textarea id="field-' + step.field + '" rows="5" placeholder="' + esc(step.placeholder) + '">' + esc(data[step.field]) + '</textarea>';
  }

  return contextoHTML +
    '<span class="step-icon">' + step.icon + '</span>' +
    '<h2 class="step-question">' + esc(step.question) + reqLabel + '</h2>' +
    '<p class="step-hint">' + esc(step.dica) + ajudaBtnHTML + '</p>' +
    ajudaBlockHTML +
    exHTML + inputHTML;
}

function renderPartes(step) {
  var contextoHTML = step.contexto ? '<div class="step-contexto">' + esc(step.contexto) + '</div>' : '';
  var ajudaBtnHTML = step.ajuda ? ' <button class="ajuda-btn" onclick="toggleAjuda(this)">Saiba mais</button>' : '';
  var ajudaBlockHTML = step.ajuda ? '<div class="ajuda-content" style="display:none">' + esc(step.ajuda) + '</div>' : '';

  var subs = [
    { key: 'patrocinio', label: 'Patrocínio e Gestão', ph: 'Quem patrocina e gerencia?', exs: step.exemplos.patrocinio },
    { key: 'equipe', label: 'Equipe Executora', ph: 'Quem vai executar?', exs: step.exemplos.equipe },
    { key: 'publico', label: 'Público-alvo', ph: 'Quem se beneficia?', exs: step.exemplos.publico }
  ];

  var html = contextoHTML +
    '<span class="step-icon">' + step.icon + '</span>' +
    '<h2 class="step-question">' + esc(step.question) + ' <span style="color:var(--accent-red);font-size:18px" title="Campo obrigatório">*</span></h2>' +
    '<p class="step-hint">' + esc(step.dica) + ajudaBtnHTML + '</p>' +
    ajudaBlockHTML;

  subs.forEach(function(s) {
    html += '<div class="partes-block">' +
      '<label class="partes-label" for="field-' + s.key + '">' + esc(s.label) + '</label>' +
      '<div class="partes-examples">\uD83D\uDCA1 Ex: ' + s.exs.map(function(e) { return esc(e); }).join(' \u2022 ') + '</div>' +
      '<textarea class="small-textarea" id="field-' + s.key + '" rows="3" placeholder="' + esc(s.ph) + '">' + esc(data[s.key]) + '</textarea>' +
    '</div>';
  });

  return html;
}

function renderEntregas(step) {
  var contextoHTML = step.contexto ? '<div class="step-contexto">' + esc(step.contexto) + '</div>' : '';
  var ajudaBtnHTML = step.ajuda ? ' <button class="ajuda-btn" onclick="toggleAjuda(this)">Saiba mais</button>' : '';
  var ajudaBlockHTML = step.ajuda ? '<div class="ajuda-content" style="display:none">' + esc(step.ajuda) + '</div>' : '';

  var exHTML = '';
  step.exemplos.forEach(function(ex, i) {
    exHTML += '<div style="font-size:12px;color:var(--text-secondary);line-height:1.5;padding:6px 0;' +
      (i < step.exemplos.length - 1 ? 'border-bottom:1px solid var(--border);' : '') + '">' +
      '<strong style="color:var(--accent-green-dark)">Entrega ' + (i+1) + ':</strong> ' + esc(ex.entrega) +
      ' <span style="color:var(--text-muted)">\u2192 ' + esc(ex.atividades) + '</span>' +
      ' <span style="color:var(--text-secondary)">(' + esc(ex.prazo) + ')</span>' +
    '</div>';
  });

  var entregasHTML = '';
  data.entregas.forEach(function(ent, i) {
    entregasHTML += '<div class="entrega-card">' +
      '<div class="entrega-header">' +
        '<span class="entrega-badge">Entrega ' + (i + 1) + '</span>' +
        (data.entregas.length > 1 ? '<button class="entrega-remove" data-idx="' + i + '">Remover</button>' : '') +
      '</div>' +
      '<div class="entrega-grid">' +
        '<div>' +
          '<label class="entrega-field-label" for="ent-' + i + '-entrega">O que será entregue?</label>' +
          '<textarea class="small-textarea" id="ent-' + i + '-entrega" rows="2">' + esc(ent.entrega) + '</textarea>' +
        '</div>' +
        '<div>' +
          '<label class="entrega-field-label" for="ent-' + i + '-atividades">Atividades necessárias</label>' +
          '<textarea class="small-textarea" id="ent-' + i + '-atividades" rows="3">' + esc(ent.atividades) + '</textarea>' +
        '</div>' +
        '<div>' +
          '<label class="entrega-field-label" for="ent-' + i + '-prazo">Prazo estimado</label>' +
          '<textarea class="small-textarea" id="ent-' + i + '-prazo" rows="1">' + esc(ent.prazo) + '</textarea>' +
        '</div>' +
        '<div>' +
          '<label class="entrega-field-label" for="ent-' + i + '-investimento">Investimento (se houver)</label>' +
          '<textarea class="small-textarea" id="ent-' + i + '-investimento" rows="1">' + esc(ent.investimento) + '</textarea>' +
        '</div>' +
      '</div>' +
    '</div>';
  });

  return contextoHTML +
    '<span class="step-icon">' + step.icon + '</span>' +
    '<h2 class="step-question">' + esc(step.question) + ' <span style="color:var(--accent-red);font-size:18px" title="Campo obrigatório">*</span></h2>' +
    '<p class="step-hint">' + esc(step.dica) + ajudaBtnHTML + '</p>' +
    ajudaBlockHTML +
    '<div class="entregas-example">' +
      '<div class="examples-label">\uD83D\uDCA1 Exemplo de entregas (Projeto CIG)</div>' +
      exHTML +
    '</div>' +
    entregasHTML +
    '<button class="btn-add-entrega" onclick="addEntrega()">+ Adicionar mais uma entrega</button>';
}

function renderSuccessScreen() {
  return '<div class="success-screen">' +
    '<div class="success-icon">\uD83C\uDF89</div>' +
    '<h2>Plano de Ação enviado com sucesso!</h2>' +
    '<p>O Plano de Ação da <strong>' + esc(data.ra || 'sua RA') + '</strong> foi recebido pela SEGOV/SEGEST.</p>' +
    (data.pratica ? '<p class="sub">Prática: ' + esc(data.pratica) + '</p>' : '') +
    '<p class="sub">Projeto: ' + esc(data.projeto || '(sem nome)') + '</p>' +
    '<div class="success-badge">\u2713 Enviado em ' + new Date().toLocaleDateString('pt-BR') + ' às ' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) + '</div>' +
    '<div class="success-actions" style="margin-top:24px">' +
      '<button class="btn-nav btn-nav-prev" onclick="showSuccess=false;render()">Voltar para revisão</button>' +
      '<button class="btn-nav btn-nav-prev" onclick="clearAllData()">Iniciar novo plano</button>' +
    '</div>' +
  '</div>';
}

function renderReview() {
  if (showSuccess) return renderSuccessScreen();

  var sections = STEPS.filter(function(s) { return s.field || s.type === 'partes' || s.type === 'entregas'; });

  function getVal(s) {
    if (s.field) return data[s.field];
    if (s.type === 'partes') return [data.patrocinio, data.equipe, data.publico].filter(Boolean).join('\n');
    if (s.type === 'entregas') return data.entregas.map(function(e, i) { return (i+1) + '. ' + e.entrega; }).filter(function(e) { return e.length > 3; }).join('\n');
    return '';
  }

  var items = '';
  sections.forEach(function(s) {
    var val = getVal(s);
    var filled = val && val.trim().length > 0;
    var idx = STEPS.indexOf(s);
    var req = isRequired(s.field || s.id);
    items += '<button class="review-item ' + (filled ? '' : (req ? 'pending' : '')) + '" data-goto="' + idx + '">' +
      '<span class="review-item-icon">' + s.icon + '</span>' +
      '<div class="review-item-body">' +
        '<div class="review-item-label ' + (filled ? 'filled' : 'empty') + '">' + esc(s.label) + (filled ? '' : (req ? ' \u26A0\uFE0F Obrigatório' : ' (opcional)')) + '</div>' +
        '<div class="review-item-preview">' + esc(val || (req ? 'Clique para preencher...' : 'Clique para preencher (opcional)...')) + '</div>' +
      '</div>' +
      '<span class="review-edit">\u270F\uFE0F</span>' +
    '</button>';
  });

  // Submit section
  var sentInfo = getSentInfo();
  var submitHTML = '';

  if (sentInfo) {
    var sentDate = new Date(sentInfo.timestamp);
    submitHTML = '<div class="already-sent">' +
      '<p>\u2713 Plano já enviado em <strong>' + sentDate.toLocaleDateString('pt-BR') + '</strong> às ' + sentDate.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) + '</p>' +
      '<button class="btn-submit" onclick="submitToSEGOV()"' + (submitting ? ' disabled' : '') + '>' +
        (submitting ? '<span class="spinner"></span>Enviando...' : '\uD83D\uDD04 Reenviar versão atualizada') +
      '</button>' +
    '</div>';
  } else {
    submitHTML = '<div class="submit-section">' +
      '<p>Revisou tudo? Quando estiver pronto, envie o Plano de Ação diretamente para a equipe SEGOV/SEGEST.<br><span style="font-size:11px;color:var(--text-muted)">Apenas os campos com * são obrigatórios. Os demais podem ser preenchidos depois.</span></p>' +
      '<button class="btn-submit" onclick="submitToSEGOV()"' + (submitting ? ' disabled' : '') + '>' +
        (submitting ? '<span class="spinner"></span>Enviando para SEGOV...' : '\uD83D\uDCE8 Enviar Plano de Ação para SEGOV') +
      '</button>' +
      '<div id="submit-error" class="error-msg" style="display:none"></div>' +
    '</div>';
  }

  return '<div class="review-header">' +
      '<div class="icon">\uD83D\uDCCB</div>' +
      '<h2>Revisão do Plano de Ação</h2>' +
      '<p>Revise as informações abaixo. Clique em qualquer seção para editar.</p>' +
      (data.ra ? '<div class="review-ra">\uD83D\uDCCD ' + esc(data.ra) + '</div>' : '') +
      (data.pratica ? '<div class="review-ra" style="margin-top:6px;background:#f5f3ff;border-color:#c4b5fd;color:#6d28d9">\uD83C\uDFDB\uFE0F ' + esc(data.pratica) + '</div>' : '') +
    '</div>' +
    items +
    submitHTML +
    '<div class="review-actions">' +
      '<button class="btn-nav btn-nav-prev" onclick="clearAllData()">Limpar tudo e recomeçar</button>' +
    '</div>';
}

/* ===================================================
   MAIN RENDER
   =================================================== */
function render() {
  var step = STEPS[currentStep];
  var pct = getProgress();
  var isFirst = currentStep === 0;
  var isLast = currentStep === STEPS.length - 1;

  var contentHTML = '';
  if (step.type === 'welcome') contentHTML = renderWelcome();
  else if (step.type === 'review') contentHTML = renderReview();
  else if (step.type === 'partes') contentHTML = renderPartes(step);
  else if (step.type === 'entregas') contentHTML = renderEntregas(step);
  else if (step.field) contentHTML = renderField(step);

  var dots = '';
  STEPS.forEach(function(s, i) {
    var cls = 'progress-dot ';
    if (i === currentStep) cls += 'progress-dot-active';
    else if (i < currentStep) cls += 'progress-dot-done';
    else cls += 'progress-dot-todo';
    var title = s.label || (s.type === 'welcome' ? 'Início' : 'Revisão');
    dots += '<button class="' + cls + '" data-goto="' + i + '" title="' + title + '" aria-label="Ir para: ' + title + '"></button>';
  });

  /* Melhoria #3: Fase atual no progresso */
  var phaseHTML = '';
  if (!isFirst && !isLast) {
    var phaseName = getPhaseForStep(step.id);
    if (phaseName) {
      phaseHTML = '<div class="phase-label">' + esc(phaseName) + '</div>';
    }
  }

  // Motivation message (only on form steps, not welcome/review)
  var motivHTML = '';
  if (!isFirst && !isLast) {
    motivHTML = '<div class="motivation no-print">' + getMotivation(pct) + '</div>';
  }

  /* Melhoria #4: Botão "Pular" nos opcionais */
  var navHTML = '';
  if (!isFirst || !step.type) {
    navHTML = '<div class="nav-row no-print">';
    navHTML += isFirst ? '<div></div>' : '<button class="btn-nav btn-nav-prev" onclick="prev()">\u2190 Anterior</button>';
    if (isLast) {
      navHTML += '<button class="btn-nav btn-nav-print" onclick="window.print()">\uD83D\uDDA8\uFE0F Imprimir / Gerar PDF</button>';
    } else {
      navHTML += '<button class="btn-nav btn-nav-next" onclick="next()">Próximo \u2192</button>';
    }
    navHTML += '</div>';
  }

  document.getElementById('app').innerHTML =
    '<div class="header no-print">' +
      '<div class="header-brand">' +
        '<span>Secretaria de Estado de Governo \u2022 Controladoria-Geral do DF</span>' +
        '<h1>Plano de Ação do CIG</h1>' +
      '</div>' +
    '</div>' +
    '<div class="progress-bar no-print">' +
      '<div class="progress-info">' +
        '<span style="color:var(--text-secondary)">Passo ' + Math.min(currentStep + 1, STEPS.length) + ' de ' + STEPS.length + '</span>' +
        '<span style="font-weight:700;color:' + (pct === 100 ? 'var(--accent-green-dark)' : 'var(--accent-blue-dark)') + '">' + pct + '% preenchido</span>' +
      '</div>' +
      '<div class="progress-track"><div class="progress-fill" style="width:' + ((currentStep / (STEPS.length - 1)) * 100) + '%"></div></div>' +
      '<div class="progress-dots">' + dots + '</div>' +
      phaseHTML +
    '</div>' +
    motivHTML +
    '<div class="step-card">' +
      '<div class="step-content">' + contentHTML + '</div>' +
    '</div>' +
    navHTML +
    '<div class="footer">' +
      'Plano de Ação do CIG \u2022 Administrações Regionais do DF<br>' +
      'Secretaria de Estado de Governo (SEGOV) \u2022 Controladoria-Geral do DF (CGDF)<br>' +
      'Modelo de Governança Pública do DF \u2014 Resolução CGOV Nº 04/2024' +
    '</div>';

  // Attach event listeners
  attachInputListeners();
  attachClickListeners();
}

function attachClickListeners() {
  // Example cards
  document.querySelectorAll('.example-card[data-field]').forEach(function(card) {
    card.addEventListener('click', handleExampleClick);
  });

  // Navigation dots and review items
  document.querySelectorAll('[data-goto]').forEach(function(el) {
    el.addEventListener('click', function() {
      goTo(parseInt(el.dataset.goto, 10));
    });
  });

  // Entrega remove buttons
  document.querySelectorAll('.entrega-remove[data-idx]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      removeEntrega(parseInt(btn.dataset.idx, 10));
    });
  });

  // Enter key on single-line input or select advances to next step
  document.querySelectorAll('#app input[type="text"], #app select').forEach(function(el) {
    el.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); next(); }
    });
  });
}

// Screen-reader only class
var styleEl = document.createElement('style');
styleEl.textContent = '.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}';
document.head.appendChild(styleEl);

// Init
loadFromStorage();
render();
</script>
</body>
</html>
